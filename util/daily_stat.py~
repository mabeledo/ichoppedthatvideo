#!/usr/bin/env python

from optparse import OptionParser
from MySQLdb import connect
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from datetime import date, timedelta
import smtplib
import socket

"""
Main function
"""
def main ():
	# Read user and password from a file, open a DB connection and
	# execute the count query.
	try:
		fd = open("/etc/spoti/passwd")
		for line in fd:
			if line.find("spoti=") > 0:
				break
	except IOError:
		print "Error opening passwd file. Aborting..."
		raise
	finally:
		fd.close()

	user = line[line.find('=') + 1:line.find(',')]
	passwd = line[line.find(',') + 1:len(line) - 2]
	
	try:
		db_conn = connect(user=user, passwd=passwd, db="spoti")
	except:
		print "** FATAL ERROR ** Could not connect to database. Aborting..."
		raise
		
	cursor = db_conn.cursor()
	cursor.execute("SELECT streams.spot_id, COUNT(*) spot_count FROM streams INNER JOIN requests ON streams.request_id = requests.id WHERE (DATEDIFF(CURRENT_TIMESTAMP(), requests.cur_timestamp) = 1) GROUP BY streams.spot_id")
	spot_counts = cursor.fetchall()
	
	# End of the DB part.
	# Proceed to compose the email message.
	fromAddr = "server@spoti.tv"
	toAddr = ['galicia@spoti.tv']
	hostname = socket.gethostname()
	msg = MIMEMultipart("alternative")
	msg["Subject"] = "Daily stats from " + hostname
	msg["From"] = fromAddr
	msg["To"] = ','.join(toAddr)
	cur_date = (date.today() - timedelta(1)).isoformat()
	
	plain = 'Number of streams served on ' + cur_date + ' in server ' + hostname + '\n\nSpot ID\tDaily total\n\n'
	html = '<html><head>Daily requests stats from server</head><body>' + '<br /><br />Number of streams served on <b>' + cur_date + '</b> in server <b>' + hostname + '</b><br /><br /><table border="0" cellpadding="5" cellspacing="5"><tr><td align="center"><b>Spot ID</b></td><td align="center"><b>Daily total</b></td></tr>'

	for spot_count in spot_counts:
		plain += str(spot_count[0]) + '\t' + str(spot_count[1]) + '\n'
		html += '<tr><td align="center">' + str(spot_count[0]) + '</td><td align="center">' + str(spot_count[1]) + '</td></tr>'

	text_part = MIMEText(plain, 'plain')
	html_part = MIMEText(html, 'html')
	msg.attach(text_part)
	msg.attach(html_part)
	
	smtp_conn = smtplib.SMTP('localhost')
	smtp_conn.sendmail(fromAddr, toAddr, msg.as_string())
	smtp_conn.quit()

if __name__ == "__main__":
    main()
